<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Video Speed Controller</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f4f8; }
        .container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: inline-block; width: 95%; max-width: 500px; }
        
        video { width: 100%; border-radius: 10px; margin-top: 15px; background: #000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .controls { margin: 20px 0; display: flex; flex-direction: column; gap: 12px; }
        button { padding: 15px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-connect { background: #28a745; color: white; }
        .btn-connect:active { background: #218838; }
        .btn-disconnect { background: #dc3545; color: white; }
        
        .file-input-wrapper { background: #eee; padding: 15px; border-radius: 10px; border: 2px dashed #ccc; position: relative; }
        input[type="file"] { width: 100%; }

        #status { margin-top: 10px; color: #666; font-size: 14px; height: 1.2em; }
        .value-box { font-size: 42px; font-weight: bold; color: #007bff; margin: 10px 0; }
        .label { font-size: 12px; color: #999; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Video Speed Bridge</h2>
    
    <video id="myVideo" controls loop muted playsinline>
        Your browser does not support the video tag.
    </video>

    <div class="controls">
        <div class="file-input-wrapper">
            <input type="file" id="filePicker" accept="video/*">
        </div>
        <button id="mainBtn" class="btn-connect">CONNECT ARDUINO</button>
    </div>

    <div class="label">Current Playback Speed</div>
    <div class="value-box" id="display">1.0x</div>
    <div id="status">Waiting for connection...</div>
</div>

<script>
    let device;
    let isConnected = false;
    const decoder = new TextDecoder();
    const encoder = new TextEncoder();
    let activeItf, epIn, epOut;

    const mainBtn = document.getElementById('mainBtn');
    const statusEl = document.getElementById('status');
    const displayEl = document.getElementById('display');
    const videoEl = document.getElementById('myVideo');
    const filePicker = document.getElementById('filePicker');

    // Load selected video file
    filePicker.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const fileURL = URL.createObjectURL(file);
            videoEl.src = fileURL;
            videoEl.play();
            statusEl.innerText = "Video Loaded & Playing";
        }
    });

    mainBtn.addEventListener('click', async () => {
        if (!isConnected) await connect();
        else await disconnect();
    });

    async function connect() {
        try {
            device = await navigator.usb.requestDevice({ filters: [] });
            await device.open();
            if (device.configuration === null) await device.selectConfiguration(1);

            let success = false;
            // Iterate common Arduino interface numbers
            for (let itf of [2, 0, 1]) {
                try {
                    await device.claimInterface(itf);
                    activeItf = itf;
                    await device.controlTransferOut({
                        requestType: 'class', recipient: 'interface',
                        request: 0x22, value: 0x01, index: itf
                    });
                    const endpoints = device.configuration.interfaces[itf].alternates[0].endpoints;
                    epIn = endpoints.find(e => e.direction === 'in').endpointNumber;
                    epOut = endpoints.find(e => e.direction === 'out').endpointNumber;
                    if (epIn && epOut) { success = true; break; }
                } catch (e) { console.warn("Failed interface", itf); }
            }

            if (success) {
                isConnected = true;
                mainBtn.innerText = "DISCONNECT ARDUINO";
                mainBtn.className = "btn-disconnect";
                statusEl.innerText = "Arduino Linked";
                readLoop();
            }
        } catch (err) { statusEl.innerText = "Error: " + err.message; }
    }

    async function disconnect() {
        isConnected = false;
        try {
            if (device) {
                await device.releaseInterface(activeItf);
                await device.close();
            }
        } catch (e) {}
        mainBtn.innerText = "CONNECT ARDUINO";
        mainBtn.className = "btn-connect";
        statusEl.innerText = "Disconnected";
        displayEl.innerText = "1.0x";
    }

    async function readLoop() {
        while (isConnected && device && device.opened) {
            try {
                const result = await device.transferIn(epIn, 64);
                if (result.data && result.data.byteLength > 0) {
                    const text = decoder.decode(result.data).trim();
                    if (text) {
                        const floatVal = parseFloat(text);
                        if (!isNaN(floatVal)) {
                            // Display the speed on screen
                            displayEl.innerText = floatVal.toFixed(1) + "x";
                            
                            // APPLY SPEED TO VIDEO
                            // Note: Browsers usually support 0.06 to 16.0
                            videoEl.playbackRate = floatVal;
                        }
                        // Echo to Arduino LCD
                        await device.transferOut(epOut, encoder.encode(text + "\n"));
                    }
                }
            } catch (e) { 
                if (isConnected) {
                    console.error(e);
                    disconnect();
                }
                break; 
            }
        }
    }
</script>
</body>
</html>
