<!DOCTYPE html>
<html>
<head>
    <title>Arduino Bridge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 30px; background: #f0f2f5; }
        .box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-block; }
        button { padding: 12px 24px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        #connect { background: #28a745; color: white; }
        #stop { background: #dc3545; color: white; display: none; }
        .display { font-size: 32px; color: #007bff; margin: 15px 0; font-weight: bold; }
    </style>
</head>
<body>

<div class="box">
    <h2>Pro Micro Bridge</h2>
    <p id="msg">Plug in and click connect</p>
    <div class="display" id="val">--</div>
    <button id="connect">Connect Arduino</button>
    <button id="stop">Disconnect</button>
</div>

<script>
    let port;
    let reader;
    let writer;

    document.getElementById('connect').addEventListener('click', async () => {
        try {
            // Request a port and open a connection.
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });

            document.getElementById('msg').innerText = "Status: Connected";
            document.getElementById('connect').style.display = "none";
            document.getElementById('stop').style.display = "inline-block";

            // Set up Streams
            const encoder = new TextEncoderStream();
            const writableStreamClosed = encoder.readable.pipeTo(port.writable);
            writer = encoder.writable.getWriter();

            startReading();

        } catch (e) {
            document.getElementById('msg').innerText = "Error: " + e.message;
        }
    });

    async function startReading() {
        const decoder = new TextDecoderStream();
        const readableStreamClosed = port.readable.pipeTo(decoder.writable);
        reader = decoder.readable.getReader();

        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value) {
                    const cleanData = value.trim();
                    if (cleanData) {
                        // Update Phone UI
                        document.getElementById('val').innerText = cleanData;
                        // ECHO back to Arduino
                        await writer.write(cleanData + "\n");
                    }
                }
            }
        } catch (error) {
            console.error(error);
        } finally {
            reader.releaseLock();
        }
    }

    document.getElementById('stop').addEventListener('click', () => {
        location.reload(); 
    });
</script>
</body>
</html>
