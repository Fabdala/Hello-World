<!DOCTYPE html>
<html>
<body>
    <div style="text-align:center; padding:20px; font-family:sans-serif;">
        <h2>Pro Micro Bridge</h2>
        <button id="connect" style="padding:20px; background:green; color:white;">CONNECT DEVICE</button>
        <div id="status">Disconnected</div>
        <h1 id="display">--</h1>
    </div>

<script>
let device;
const decoder = new TextDecoder();
const encoder = new TextEncoder();

document.getElementById('connect').addEventListener('click', async () => {
    try {
        // Look for ANY device to see if the Pro Micro shows up
        device = await navigator.usb.requestDevice({ filters: [] });
        
        await device.open();
        await device.selectConfiguration(1);
        
        // On Pro Micro, the Serial data is usually on Interface 2
        await device.claimInterface(2);
        
        // This line tells the Pro Micro "The phone is ready!" (DTR signal)
        await device.controlTransferOut({
            requestType: 'class',
            recipient: 'interface',
            request: 0x22, value: 0x01, index: 2
        });

        document.getElementById('status').innerText = "Connected!";
        readLoop();
    } catch (e) {
        document.getElementById('status').innerText = e.message;
    }
});

async function readLoop() {
    while (device && device.opened) {
        try {
            const result = await device.transferIn(2, 64); // Endpoint 2 is standard for CDC
            const text = decoder.decode(result.data).trim();
            if (text) {
                document.getElementById('display').innerText = text;
                // ECHO BACK
                await device.transferOut(2, encoder.encode(text + "\n"));
            }
        } catch (e) { console.error(e); break; }
    }
}
</script>
</body>
</html>
