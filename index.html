<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Binary Video Control</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f4f8; transition: filter 0.3s; }
        .container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: inline-block; width: 95%; max-width: 500px; }
        video { width: 100%; border-radius: 10px; margin-top: 15px; background: #000; }
        .controls { margin: 20px 0; display: flex; flex-direction: column; gap: 10px; }
        button { padding: 15px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .btn-connect { background: #28a745; color: white; }
        .btn-play { background: #007bff; color: white; }
        .value-box { font-size: 48px; font-weight: bold; color: #007bff; margin: 5px 0; }
        #status { color: #666; font-size: 14px; margin-top: 10px; font-style: italic; }
        .label { font-size: 12px; color: #999; text-transform: uppercase; margin-top: 10px; }
        .math-info { font-size: 16px; color: #444; background: #e9ecef; padding: 10px; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Dynamic Speed Bridge</h2>
    
    <video id="myVideo" loop muted playsinline>
        Your browser does not support the video tag.
    </video>

    <div class="controls">
        <input type="file" id="filePicker" accept="video/*">
        <button id="playBtn" class="btn-play">1. START VIDEO</button>
        <button id="mainBtn" class="btn-connect">2. CONNECT ARDUINO</button>
    </div>

    <div class="math-info" id="mathDisplay">Select a video to set Average Speed</div>
    <div class="label">Calculated Playback Ratio</div>
    <div class="value-box" id="display">1.00x</div>
    <div id="status">Waiting for binary data...</div>
</div>

<script>
    let isTransitioning = false; 

    async function readLoop() {
        while (isConnected && device && device.opened) {
            try {
                const result = await device.transferIn(epIn, 4);
                
                if (result.data && result.data.byteLength === 4) {
                    const view = new DataView(result.data.buffer);
                    const arduinoVel = view.getFloat32(0, true); 
                             
                    // COLLISION GUARD: Only process if not currently changing states
                    if (!isTransitioning) {
                        if (arduinoVel > 0.1) {
                            if (videoEl.paused) {
                                isTransitioning = true; // LOCK
                                videoEl.play()
                                    .then(() => { isTransitioning = false; }) // UNLOCK ON SUCCESS
                                    .catch(e => { isTransitioning = false; }); // UNLOCK ON ERROR
                            }
                            
                            const safeRatio = Math.max(0.06, Math.min(16, arduinoVel / avgSpeed));
                            if (Math.abs(lastSetRate - safeRatio) > 0.01) {
                                videoEl.playbackRate = safeRatio;
                                lastSetRate = safeRatio;
                                displayEl.innerText = safeRatio.toFixed(2) + "x";
                            }
                        } else { 
                            if (!videoEl.paused) {
                                isTransitioning = true; // LOCK
                                videoEl.pause();
                                isTransitioning = false; // Pause is usually near-instant
                                displayEl.innerText = "0.00x (Paused)";
                                lastSetRate = 0;
                            }
                        }
                    }

                    // Request next packet from Arduino
                    await sendAck();
                }
            } catch (e) { 
                await new Promise(r => setTimeout(r, 100));
                await sendAck(); 
            }
        }
    }
</script>
</body>
</html>
